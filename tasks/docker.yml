version: "3"

vars:
  REGISTRY: ghcr.io
  IMAGE_NAME: "{{.REGISTRY}}/{{.DOCKER_IMAGE_NAME}}"
  PLATFORMS: "linux/amd64,linux/arm64"

tasks:
  # Basic Docker tasks
  build:
    desc: Build Docker image (single platform)
    silent: true
    cmds:
    - docker build -t {{.DOCKER_IMAGE_NAME}}:{{.VERSION}} .
    - echo "âœ… Docker image built - {{.DOCKER_IMAGE_NAME}}:{{.VERSION}}"

  build:multi:
    desc: Build Docker image for multiple platforms (like CI)
    silent: true
    cmds:
    - docker buildx create --use --name multi-builder 2>/dev/null || docker buildx use multi-builder
    - docker buildx build --platform {{.PLATFORMS}} -t {{.IMAGE_NAME}}:{{.VERSION}} -t {{.IMAGE_NAME}}:latest .
    - echo "âœ… Multi-platform Docker image built - {{.IMAGE_NAME}}:{{.VERSION}}"

  build:ci:
    desc: Build Docker image exactly like CI (with buildx and cache)
    silent: true
    cmds:
    - docker buildx create --use --name ci-builder 2>/dev/null || docker buildx use ci-builder
    - |
      docker buildx build \
        --platform {{.PLATFORMS}} \
        --cache-from type=local,src=/tmp/.buildx-cache \
        --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
        -t {{.IMAGE_NAME}}:{{.VERSION}} \
        -t {{.IMAGE_NAME}}:latest \
        --load .
    - rm -rf /tmp/.buildx-cache && mv /tmp/.buildx-cache-new /tmp/.buildx-cache 2>/dev/null || true
    - echo "âœ… CI-style Docker image built - {{.IMAGE_NAME}}:{{.VERSION}}"

  run:
    desc: Run Docker container
    silent: true
    cmds:
    - docker run --rm -p 8080:8080 --name {{.DOCKER_IMAGE_NAME}}-dev {{.DOCKER_IMAGE_NAME}}:{{.VERSION}}

  run:detached:
    desc: Run Docker container in background
    silent: true
    cmds:
    - docker run -d -p 8080:8080 --name {{.DOCKER_IMAGE_NAME}}-dev {{.DOCKER_IMAGE_NAME}}:{{.VERSION}}
    - echo "âœ… Docker container started in background - {{.DOCKER_IMAGE_NAME}}:{{.VERSION}}"

  test:
    desc: Test Docker image (like CI)
    silent: true
    cmds:
    - echo "ðŸ§ª Testing Docker image..."
    - docker run --rm -d --name test-container -p 8081:8080 {{.DOCKER_IMAGE_NAME}}:{{.VERSION}}
    - sleep 5
    - echo "âœ… Container started successfully"
    - docker stop test-container
    - echo "âœ… Docker image test completed successfully"

  scan:
    desc: Run Trivy vulnerability scanner (like CI)
    silent: true
    cmds:
    - echo "ðŸ” Scanning Docker image for vulnerabilities..."
    - trivy image --format table {{.DOCKER_IMAGE_NAME}}:{{.VERSION}}
    - echo "âœ… Vulnerability scan completed"

  scan:sarif:
    desc: Run Trivy vulnerability scanner with SARIF output (like CI)
    silent: true
    cmds:
    - mkdir -p reports
    - echo "ðŸ” Scanning Docker image for vulnerabilities (SARIF output)..."
    - trivy image --format sarif --output reports/trivy-results.sarif {{.DOCKER_IMAGE_NAME}}:{{.VERSION}}
    - echo "âœ… Vulnerability scan completed - results saved to reports/trivy-results.sarif"

  push:
    desc: Push Docker image to registry
    silent: true
    cmds:
    - docker push {{.IMAGE_NAME}}:{{.VERSION}}
    - docker push {{.IMAGE_NAME}}:latest
    - echo "âœ… Docker image pushed - {{.IMAGE_NAME}}:{{.VERSION}}"

  login:
    desc: Login to GitHub Container Registry
    silent: true
    cmds:
    - echo "ðŸ” Logging into GitHub Container Registry..."
    - echo "Please provide your GitHub Personal Access Token with packages:write permission"
    - docker login {{.REGISTRY}} -u $GITHUB_USERNAME
    - echo "âœ… Successfully logged into {{.REGISTRY}}"

  # CI-like workflow
  ci:
    desc: Run complete Docker CI workflow locally
    silent: true
    cmds:
    - task: build:ci
    - task: test
    - task: scan
    - echo "âœ… Complete Docker CI workflow completed successfully"

  # Cleanup tasks
  clean:
    desc: Remove Docker image
    silent: true
    cmds:
    - docker rmi {{.DOCKER_IMAGE_NAME}}:{{.VERSION}} 2>/dev/null || echo "Image not found - {{.DOCKER_IMAGE_NAME}}:{{.VERSION}}"
    - echo "âœ… Docker image cleanup completed"

  clean:all:
    desc: Remove all unused Docker images, containers, and networks
    silent: true
    cmds:
    - docker system prune -f
    - echo "âœ… Docker system cleanup completed"

  clean:buildx:
    desc: Clean buildx cache and builders
    silent: true
    cmds:
    - docker buildx prune -f
    - docker buildx rm multi-builder 2>/dev/null || true
    - docker buildx rm ci-builder 2>/dev/null || true
    - rm -rf /tmp/.buildx-cache 2>/dev/null || true
    - echo "âœ… Buildx cleanup completed"

  # Utility tasks
  logs:
    desc: Show logs from running container
    silent: true
    cmds:
    - docker logs $(docker ps -q --filter ancestor={{.DOCKER_IMAGE_NAME}}:{{.VERSION}}) 2>/dev/null || echo "No running containers found"

  stop:
    desc: Stop running container
    silent: true
    cmds:
    - docker stop $(docker ps -q --filter ancestor={{.DOCKER_IMAGE_NAME}}:{{.VERSION}}) 2>/dev/null || echo "No running containers found"
    - echo "âœ… Container stopped"

  inspect:
    desc: Inspect Docker image
    silent: true
    cmds:
    - docker inspect {{.DOCKER_IMAGE_NAME}}:{{.VERSION}}
